name: ğŸŒ± Update Environmental Dashboard

on:
  schedule:
    # æ¯å¤©UTC 0:00è¿è¡Œ (æ¾³æ´²ä¸œéƒ¨æ—¶é—´ä¸Šåˆ10:00æˆ–11:00ï¼Œå–å†³äºå¤ä»¤æ—¶)
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ] # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘(ç”¨äºæµ‹è¯•)

jobs:
  update-dashboard-data:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”„ æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: âš™ï¸  å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "ğŸ“‹ å·²å®‰è£…ä¾èµ–åŒ…"

    - name: ğŸ“ åˆ›å»ºæ•°æ®ç›®å½•
      run: |
        mkdir -p data
        echo "ğŸ“‚ æ•°æ®ç›®å½•å·²å‡†å¤‡"

    - name: ğŸŒ± æŠ“å–ç¯å¢ƒç§‘å­¦æ–°é—»
      run: |
        echo "ğŸ” å¼€å§‹æŠ“å–ç¯å¢ƒç§‘å­¦æ–°é—»..."
        python scrape_env_news.py
      continue-on-error: true

    - name: ğŸ¤– æ”¶é›†AIå·¥å…·æ¨è
      run: |
        echo "ğŸ” å¼€å§‹æ”¶é›†AIå·¥å…·æ¨è..."
        python scrape_ai_tools.py
      continue-on-error: true

    - name: ğŸ’¼ æ”¶é›†å®è·µæœºä¼šä¿¡æ¯
      run: |
        echo "ğŸ” å¼€å§‹æ”¶é›†å®è·µæœºä¼š..."
        python scrape_opportunities.py  
      continue-on-error: true

    - name: ğŸ“Š å¤„ç†å’Œæ•´åˆæ•°æ®
      run: |
        echo "ğŸ“ˆ å¼€å§‹æ•°æ®å¤„ç†å’Œæ•´åˆ..."
        python data_processor.py

    - name: ğŸ“‹ æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "ğŸ“‚ æ£€æŸ¥ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶ï¼š"
        ls -la data/ || echo "æ•°æ®ç›®å½•ä¸ºç©º"

    - name: âœ… æäº¤æ•°æ®æ›´æ–°
      run: |
        git config --local user.email "envdashboard@github-actions.com"
        git config --local user.name "ğŸŒ± Environmental Dashboard Bot"

        git add data/

        if git diff --staged --quiet; then
          echo "ğŸ“‹ æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æœ¬æ¬¡æäº¤"
        else
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ç¯å¢ƒç§‘å­¦ä»ªè¡¨ç›˜æ•°æ® - $TIMESTAMP"
          git push origin main
          echo "âœ… æ•°æ®æ›´æ–°å®Œæˆå¹¶å·²æ¨é€åˆ°ä»“åº“"
          echo "ğŸ“Š æ›´æ–°æ—¶é—´: $TIMESTAMP"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ‰ æ›´æ–°å®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ¯ ä»ªè¡¨ç›˜æ•°æ®æ›´æ–°æµç¨‹å®Œæˆï¼"
        echo "ğŸŒ æ‚¨çš„ä»ªè¡¨ç›˜åœ°å€: https://${{ github.repository_owner }}.github.io/daily-env-dashboard/dashboard/"
        echo "â° ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–°: æ˜å¤©åŒä¸€æ—¶é—´"
